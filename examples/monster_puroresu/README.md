# Etripator Walkthrough
## Disassembling Monster Puroresu
### Initial setup
We will start with nothing but a good old terminal, the **etripator** binary and the ROM (I don't want to know how you got it) of **Monster Puroresu**. So basically your working directory may look like this:
```
➜  ll
total 596
drwxr-xr-x 2 blockos blockos   4096 Oct 10 14:00 ./
drwxr-xr-x 7 blockos blockos   4096 Oct 10 13:59 ../
-rwxr-xr-x 1 blockos blockos  74187 Oct  6 19:33 etripator*
-rw-r--r-- 1 blockos blockos 524288 Oct 10 14:00 monster_puroresu.pce
```
### IRQ vectors extraction
As we are starting from scratch, the first thing to do is to a perform an automatic IRQ vectors extraction. This is done by calling **etripator** with **-i** (or **--irq-detect**).
```
➜ ./etripator -i monster_puroresu.pce 
irq_2 found at fff0 (1ff0)
irq_1 found at e058 (58)
irq_timer found at fff0 (1ff0)
irq_nmi found at fff0 (1ff0)
irq_reset found at e000 (0)
 
irq_2:
 
irq_1:
e05f short jump to e068 (00000068)
e065 short jump to e07d (0000007d)
 
irq_timer:
 
irq_nmi:
 
irq_reset:
e02f short jump to e029 (00000029)
e040 short jump to e033 (00000033)
e046 long jump to e138 (00000138) 
e049 long jump to e0cc (000000cc) 
e051 long jump to e4b5 (000004b5) 
e055 long jump to e055 (00000055) 
e05f short jump to e068 (00000068)
e065 short jump to e07d (0000007d)
```
**etripator** first outputs the logical and physical address of the 5 PC Engine IRQ vectors. A code section is automatically created for IRQ vector. Each section will be output in a different file. Namely:
 * irq_1.asm
 * irq_2.asm
 * irq_timer.asm
 * irq_nmi.asm
 * irq_reset.asm
 
Then comes a summary of the disassembly of each section. Each time a branch or jump instruction, the address where the jump occurs and the destination is output.

From this output we see that irq_2, irq_timer and irq_nmi all points to the same address. The last 2 elements of the jump list of irq_reset matches the ones from irq_1. This means that both interrupts overlaps. It usually happens when there is no _return_ instruction. There could be an infinite loop before irq_1 or some jumps. When automatic IRQ vectors extraction or no size is specified in the configuration file, the disassembly of a code section stops when **RTS** or **RTI** instruction is found.

A new configuration file will be created in order to overcome those issues.
```ini
[irq_reset]
filename=startup.asm
type=code
bank=0
org=e000

[irq_dummy]
filename=startup.asm
type=code
bank=0
org=fff0

[irq_vectors]
filename=startup.asm
type=inc_data
bank=0
org=fff6
size=a
```

Before running **etripator** with the new configuration, we should remove the files generated by the IRQ vectors extraction in order to keep a somehow clean workspace.
```
➜  rm *.asm
➜  ./etripator monster.cfg monster_puroresu.pce 
 
irq_reset:
e02f short jump to e029 (00000029)
e040 short jump to e033 (00000033)
e046 long jump to e138 (00000138) 
e049 long jump to e0cc (000000cc) 
e051 long jump to e4b5 (000004b5) 
e055 long jump to e055 (00000055) 
e05f short jump to e068 (00000068)
e065 short jump to e07d (0000007d)
 
irq_dummy:
```

Let's take a look at _startup.asm_.
```
	.code
	.bank 0
	.org $e000
irq_reset:
          NOP     
          SEI     
          CSH     
          CLD     
          LDA     #$ff
          TAM     #$00
          LDA     #$f8
          TAM     #$01
          LDA     #$04
          TAM     #$02
          LDA     #$05
          TAM     #$03
          LDA     #$01
          TAM     #$04
          LDA     #$02
          TAM     #$05
          LDA     #$03
          TAM     #$06
          LDA     #$00
          TAM     #$07
          LDX     #$ff
          TXS     
          CLX     
          CLA     
le029_00:
          STA     <$00, X
          STA     $2100, X
          INX     
          BNE     le029_00
          LDY     #$07
le033_00:
          DEY     
          STY     $0800
          STZ     $0804
          STZ     $0805
          STZ     $0807
          BNE     le033_00
          LDX     #$c4
          LDY     #$be
          JSR     le138_00
          JSR     le0cc_00
          LDA     #$05
          STA     $1402
          JSR     le4b5_00
          CLI     
le055_00:
          JMP     le055_00
          LDA     $0000
          STA     <$10
          AND     #$20
          BNE     le068_00
          LDA     <$10
          AND     #$04
          BNE     le07d_00
          RTI     

	.code
	.bank 0
	.org $fff0
irq_dummy:
          RTI     

	.data
	.bank 0
	.org $fff6
irq_vectors:
    .db $f0,$ff,$58,$e0,$f0,$ff,$f0,$ff
    .db $00,$e0
```

Everything seems OK. Except that irq_1 and irq_reset are fused together.

### irq_reset
irq_reset is the first piece of code executed when you power up your console.


```
          NOP     
          SEI
```
The **NOP** instruction does nothing. You can see it as a 2 cycles wait. **SEI** disables interruptions. 


```
          CSH     
          CLD     
```
The CPU is switched high speed (**CSH**) and the decimal flag is cleared (**CLD**).

```
          LDA     #$ff
          TAM     #$00
          LDA     #$f8
```
Maps the I/O page to mpr #0 and  the RAM page to mpr #1.


```
          LDA     #$04
          TAM     #$02
          LDA     #$05
          TAM     #$03
          LDA     #$01
          TAM     #$04
          LDA     #$02
          TAM     #$05
          LDA     #$03
          TAM     #$06
          LDA     #$00
          TAM     #$07
```
Maps some ROM banks to mpr #2 to #7.


```
          LDX     #$ff
          TXS     
```
Reset stack pointer. The stack index is decremented each time a byte is pushed onto the stack.

```
          CLX     
          CLA     
le029_00:
          STA     <$00, X
          STA     $2100, X
          INX     
          BNE     le029_00
```
Clears zero-page and stack memory. le029_00 can be renamed to .clear_zp_sp. This is done by creating what is called a label definition file. Here we will call it labels.cfg.
```ini                                                                                                                                                 
[.clear_zp_sp]
logical=e029
physical=000029
```

Back on irq_reset.
```
          LDY     #$07
le033_00:
          DEY     
          STY     $0800
          STZ     $0804
          STZ     $0805
          STZ     $0807
          BNE     le033_00
```
$0800 is the PSG channel select register. $0804 is the PSG channel control register, $0805 channel balance and $0807 noise control register. Basically this loops will mute every PSG channels. A new entry may be added to the label definition file. For example, le033_00 will be renamed .mute_channels.
```ini
[.mute_channels]
logical=e033
physical=000
```

We are nearly at the end of irq_reset.
```
          LDX     #$c4
          LDY     #$be
          JSR     le138_00
          JSR     le0cc_00
          LDA     #$05
          STA     $1402
          JSR     le4b5_00
          CLI     
le055_00:
          JMP     le055_00
          
          LDA     $0000
          STA     <$10
          AND     #$20
          BNE     le068_00
          LDA     <$10
          AND     #$04
          BNE     le07d_00
          RTI     
```
There is an infinite loop at le055_00. Remember that irq_1 starts at $e058 which is just after **_JMP le055_00_**.  This means that we can calculte the size of the irq_reset section, which is 88 (#$58 in hexadecimal). The section for le138_00, le0cc_00 and le4b5_00 routines can also be added.
```ini
[irq_reset]
filename=startup.asm
type=code
bank=0
org=e000
size=58

[irq_1]
filename=startup.asm
type=code
bank=0
org=e058

[unknown0]
filename=startup.asm
type=code
bank=0
org=e138

[unkown1]
filename=startup.asm
type=code
bank=0
org=e0cc

[unknown2]
filename=startup.asm
type=code
bank=0
org=e4b5

; [...] 
```
The label definition files is updated as follow.
```ini
[clear_zp_sp]
logical=e029
physical=000029

[.mute_channels]
logical=e033
physical=000033

[.loop]
logical=e055
physical=000055
```

Run **etripator** with the **-l** (or **--labels**) options.
```
➜ ./etripator -l labels.cfg monster.cfg monster_puroresu.pce 
irq_reset:
e02f short jump to e029 (00000029)
e040 short jump to e033 (00000033)
e046 long jump to e138 (00000138) 
e049 long jump to e0cc (000000cc) 
e051 long jump to e4b5 (000004b5) 
e055 long jump to e055 (00000055) 
 
irq_1:
e05f short jump to e068 (00000068)
e065 short jump to e07d (0000007d)
 
unknown0:
e142 short jump to e146 (00000146)
e159 short jump to e15d (0000015d)
 
unkown1:
 
unknown2:
 
irq_dummy:
```

Opens startup.asm. Labels in irq_reset may have been replaced by the ones defined in the label definition file.
```
	.code
	.bank 0
	.org $e000
irq_reset:
          NOP     
          SEI     
          CSH     
          CLD     
          LDA     #$ff
          TAM     #$00
          LDA     #$f8
          TAM     #$01
          LDA     #$04
          TAM     #$02
          LDA     #$05
          TAM     #$03
          LDA     #$01
          TAM     #$04
          LDA     #$02
          TAM     #$05
          LDA     #$03
          TAM     #$06
          LDA     #$00
          TAM     #$07
          LDX     #$ff
          TXS     
          CLX     
          CLA     
clear_zp_sp:
          STA     <$00, X
          STA     $2100, X
          INX     
          BNE     clear_zp_sp
          LDY     #$07
.mute_channels:
          DEY     
          STY     $0800
          STZ     $0804
          STZ     $0805
          STZ     $0807
          BNE     .mute_channels
          LDX     #$c4
          LDY     #$be
          JSR     unknown0
          JSR     unkown1
          LDA     #$05
          STA     $1402
          JSR     unknown2
          CLI     
.loop:
          JMP     .loop
```

### irq_1
The current disassembly of irq_1 is :
```
        .code
        .bank 0
        .org $e058
irq_1:
          LDA     $0000
          STA     <$10
          AND     #$20
          BNE     le068_01
          LDA     <$10
          AND     #$04
          BNE     le07d_01
          RTI 
```
The automatic disassembly stops at the RTI instruction. Nevertheless, there are 2 conditional branches.
One to $e068 and another one to $e07d.
Let's extend irq_1 section to #$30.

```ini
[irq_1]
filename=startup.asm
type=code
bank=0
org=e058
size=30
```
Unfortunately that is too low.
```
irq_1:                                                                                                                                                                    
          LDA     $0000                                                                                                                                                   
          STA     <$10                                                                                                                                                    
          AND     #$20                                                                                                                                                    
          BNE     le068_01                                                                                                                                                
          LDA     <$10                                                                                                                                                    
          AND     #$04                                                                                                                                                    
          BNE     le07d_01                                                                                                                                                
          RTI                                                                                                                                                             
le068_01:                                                                                                                                                                 
          JSR     unknown2                                                                                                                                                
          JSR     le0ad_01                                                                                                                                                
          JSR     la0b6_01                                                                                                                                                
          JSR     unkown1                                                                                                                                                 
          JSR     le4ca_01                                                                                                                                                
          JSR     lfbc2_01                                                                                                                                                
          INC     <$08                                                                                                                                                    
          RTI                                                                                                                                                             
le07d_01:                                                                                                                                                                 
          PHA                                                                                                                                                             
          LDA     #$07                                                                                                                                                    
          STA     $0000                                                                                                                                                   
          LDA     #$00                                                                                                                                                    
          STA     $0002
```

Expand it to #$60.  We see that 

```
le07d_01:
          PHA     
          LDA     #$07
          STA     $0000
          LDA     #$00
          STA     $0002
          LDA     #$01
          STA     $0003
          LDA     #$08
          STA     $0000
          LDA     #$80
          STA     $0002
          LDA     #$01
          STA     $0003
          LDA     #$05
          STA     $0000
          LDA     #$8c
          STA     $0002
          LDA     <$41
          STA     $0003
          PLA     
          RTI     
le0ad_01:
          LDA     #$07
          STA     $0000
          LDA     <$04
          STA     $0002
          LDA     <$05
```
An RTI is caught but the size of the section is a little too big.
Hopefully, the $e0ad subroutine starts just after.
The section size is then #$e0ad-#$e058 which is equals to #$55.
```
irq_1:
          LDA     $0000
          STA     <$10
          AND     #$20
          BNE     le068_01
          LDA     <$10
          AND     #$04
          BNE     le07d_01
          RTI     
le068_01:
          JSR     unknown2
          JSR     le0ad_01
          JSR     la0b6_01
          JSR     unkown1
          JSR     le4ca_01
          JSR     lfbc2_01
          INC     <$08
          RTI     
le07d_01:
          PHA     
          LDA     #$07
          STA     $0000
          LDA     #$00
          STA     $0002
          LDA     #$01
          STA     $0003
          LDA     #$08
          STA     $0000
          LDA     #$80
          STA     $0002
          LDA     #$01
          STA     $0003
          LDA     #$05
          STA     $0000
          LDA     #$8c
          STA     $0002
          LDA     <$41
          STA     $0003
          PLA     
          RTI
```
irq_1 starts by comparing if the 6th bit of the VDC status register. This bit is set when a vertical blank interrupt occurs. le068_01 can be renamed .vblank. Next, the 3th bit is tested which is set when the raster compare (of horizontal blank) interrupt occurs. Hence le07d_01 can be renamed .hblank. 

.vblank successively jumpts to 6 subroutines. 2 of them were already encountered (they are names unknown1 and unknown2 for the moment). 3 subroutines are located in the first bank (le0ad_01, le4ca_01 and lfbc2_01). In order to indentify the ROM bank where la0b6_b1 is, the value of the MPR #5 (#$a0b6 >> 13 = 5). The ROM bank #0 subroutines will be examined first in order to see if the mpr #5 is explicitely mapped. If that is not the case, the value set in the irq_reset will be used (#$02). 

